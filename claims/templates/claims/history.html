{% extends 'claims/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block main_class %}px-4 py-6{% endblock %}

{% block content %}
<div class="w-full max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl shadow-2xl p-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-custom-blue mb-2">Query History</h1>
            <p class="text-gray-600">View and search through your previous insurance queries</p>
        </div>

        <!-- Search Form -->
        <div class="mb-6">
            <form method="get" class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    {{ search_form.search }}
                </div>
                <div>
                    {{ search_form.status }}
                </div>
                <button type="submit" class="bg-custom-blue text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                    Search
                </button>
                <a href="{% url 'claims:history' %}" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 text-center">
                    Clear
                </a>
            </form>
        </div>

        <!-- Results -->
        {% if queries %}
            <div class="space-y-4">
                {% for query in queries %}
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <!-- Query Info -->
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-sm font-medium text-gray-500">#{{ query.id }}</span>
                                    <span class="text-sm text-gray-500">•</span>
                                    <span class="text-sm text-gray-500">{{ query.submitted_at|date:"M d, Y \a\t H:i" }}</span>
                                    {% if query.processing_time_seconds %}
                                        <span class="text-sm text-gray-500">•</span>
                                        <span class="text-sm text-gray-500">{{ query.processing_time_seconds|floatformat:"2" }}s</span>
                                    {% endif %}
                                </div>
                                
                                <!-- Query Text -->
                                <p class="text-gray-800 mb-3">{{ query.query_text|truncatewords:20 }}</p>
                                
                                <!-- Quick Details -->
                                <div class="flex flex-wrap gap-2 text-sm">
                                    {% if query.procedure %}
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ query.procedure }}</span>
                                    {% endif %}
                                    {% if query.location %}
                                        <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">{{ query.location }}</span>
                                    {% endif %}
                                    {% if query.age %}
                                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">Age {{ query.age }}</span>
                                    {% endif %}
                                    {% if query.policy_age %}
                                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">{{ query.policy_age }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4 ml-4">
                                <!-- Status Badge -->
                                <div class="text-center">
                                    <div class="px-3 py-1 rounded-full text-sm font-medium {% if query.status == 'APPROVED' %}bg-green-100 text-approved-green{% elif query.status == 'REJECTED' %}bg-red-100 text-rejected-red{% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                        {{ query.status|default:"PENDING" }}
                                    </div>
                                    {% if query.payout %}
                                        <div class="text-sm font-bold text-blue-900 mt-1">₹{{ query.payout|floatformat:"0" }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Actions -->
                                <div class="flex flex-col space-y-1">
                                    <a href="{% url 'claims:query_result' query.id %}" class="bg-custom-blue text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors duration-200 text-center">
                                        View
                                    </a>
                                    <a href="{% url 'claims:detail' query.id %}" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition-colors duration-200 text-center">
                                        Details
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reasoning Preview -->
                        {% if query.reasons.all %}
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <div class="text-sm text-gray-600">
                                    <strong>Top Reasons:</strong>
                                    {% for reason in query.reasons.all|slice:":2" %}
                                        {{ reason.reason_text|truncatewords:8 }}{% if not forloop.last %} • {% endif %}
                                    {% endfor %}
                                    {% if query.reasons.all.count > 2 %}
                                        ... <a href="{% url 'claims:detail' query.id %}" class="text-custom-blue hover:underline">view all</a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="flex justify-center mt-8">
                    <nav class="flex space-x-1">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 rounded-l-md">First</a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 hover:bg-gray-50">Previous</a>
                        {% endif %}
                        
                        <span class="px-3 py-2 text-sm bg-custom-blue border border-custom-blue text-white">
                            {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 hover:bg-gray-50">Next</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 hover:bg-gray-50 rounded-r-md">Last</a>
                        {% endif %}
                    </nav>
                </div>
            {% endif %}

        {% else %}
            <div class="text-center py-12">
                <div class="text-gray-500 text-lg mb-4">No queries found</div>
                <p class="text-gray-400 mb-6">
                    {% if request.GET.search or request.GET.status %}
                        No queries match your search criteria.
                    {% else %}
                        You haven't submitted any insurance queries yet.
                    {% endif %}
                </p>
                <a href="{% url 'claims:home' %}" class="bg-custom-blue text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                    Submit Your First Query
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
